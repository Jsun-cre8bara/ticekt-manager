"""
ì›¹ìš© í†µí•© íŒŒì„œ ëª¨ë“ˆ
ê¸°ì¡´ ì˜ˆë§¤ì²˜ë³„ íŒŒì„œë¥¼ ì›¹ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í†µí•©
ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ê¸°ëŠ¥ í¬í•¨
"""

import pandas as pd
from datetime import datetime
import re
from database import get_session, Reservation
from sqlalchemy.exc import IntegrityError


# ========== ê³µí†µ í•¨ìˆ˜ ==========
def ê³µì—°ëª…ì •ê·œí™”(ê³µì—°ëª…):
    """ê³µì—°ëª…ì˜ ê´„í˜¸ ì¢…ë¥˜ë¥¼ í†µì¼ (ã€ˆã€‰, [] â†’ ())"""
    ì •ê·œí™” = ê³µì—°ëª….replace('ã€ˆ', '(').replace('ã€‰', ')')
    ì •ê·œí™” = ì •ê·œí™”.replace('[', '(').replace(']', ')')
    ì •ê·œí™” = ì •ê·œí™”.replace('ã€', '(').replace('ã€‘', ')')
    return ì •ê·œí™”


# ========== YES24 íŒŒì„œ ==========
def parse_yes24(íŒŒì¼ê²½ë¡œ):
    """
    YES24 ì˜ˆë§¤ë‚´ì—­ ì—‘ì…€ íŒŒì¼ íŒŒì‹±
    
    íŒŒì¼ êµ¬ì¡°:
    - ì‹œíŠ¸: ë‚ ì§œë³„ ë˜ëŠ” ë‚ ì§œ(íšŒì°¨)ë³„
    - í–‰5, ì—´9: ê³µì—°ëª…
    - í–‰6, ì—´9: ê³µì—°ì¼ì‹œ
    - í–‰20~: ì˜ˆë§¤ì ë°ì´í„°
    
    Returns:
        list: ì˜ˆë§¤ ë°ì´í„° ë¦¬ìŠ¤íŠ¸
    """
    print("ğŸ“¥ YES24 íŒŒì¼ ë¶„ì„ ì¤‘...")
    xlsx = pd.ExcelFile(íŒŒì¼ê²½ë¡œ)
    ê²°ê³¼ëª©ë¡ = []
    
    for sheet_name in xlsx.sheet_names:
        df = pd.read_excel(xlsx, sheet_name=sheet_name, header=None)
        
        # í—¤ë” ì •ë³´ ì¶”ì¶œ
        ê³µì—°ëª…_ì›ë³¸ = df.iloc[4, 9]
        ê³µì—°ëª… = ê³µì—°ëª…ì •ê·œí™”(ê³µì—°ëª…_ì›ë³¸)
        
        ê³µì—°ì¼ì‹œ_ì›ë³¸ = str(df.iloc[5, 9])
        ê³µì—°ì¼ = ê³µì—°ì¼ì‹œ_ì›ë³¸[:10]
        ê³µì—°ì‹œê°„ = ê³µì—°ì¼ì‹œ_ì›ë³¸[11:16]
        
        # íšŒì°¨ ì •ë³´
        if '(' in sheet_name:
            íšŒì°¨ë²ˆí˜¸ = sheet_name.split('(')[1].replace(')', '')
        else:
            íšŒì°¨ë²ˆí˜¸ = "1"
        
        íšŒì°¨ì •ë³´ = f"{íšŒì°¨ë²ˆí˜¸}íšŒì°¨ {ê³µì—°ì‹œê°„}"
        
        # ì˜ˆë§¤ì ë°ì´í„° ì¶”ì¶œ
        for i in range(20, len(df)):
            row = df.iloc[i]
            í‹°ì¼“ë²ˆí˜¸ = row[12]
            
            if pd.isna(í‹°ì¼“ë²ˆí˜¸) or not str(í‹°ì¼“ë²ˆí˜¸).startswith('Y'):
                continue
            
            ì¢Œì„ì •ë³´ = row[16] if pd.notna(row[16]) else "ë¹„ì§€ì •ì„"
            ê°€ê²© = str(int(row[18])) if pd.notna(row[18]) else "0"
            
            ê²°ê³¼ëª©ë¡.append({
                'ê³µì—°ëª…': ê³µì—°ëª…,
                'ê³µì—°ì¼': ê³µì—°ì¼,
                'íšŒì°¨ì •ë³´': íšŒì°¨ì •ë³´,
                'ì˜ˆë§¤ì': str(row[1]),
                'í‹°ì¼“ë²ˆí˜¸': str(í‹°ì¼“ë²ˆí˜¸),
                'ì¢Œì„ì •ë³´': str(ì¢Œì„ì •ë³´),
                'ê°€ê²©': ê°€ê²©,
                'ì „í™”ë²ˆí˜¸': str(row[4]),
                'ì¶œì²˜': 'YES24'
            })
        
        print(f"  âœ… {sheet_name} - {len([x for x in ê²°ê³¼ëª©ë¡ if x['ì¶œì²˜']=='YES24'])}ëª… ì¶”ì¶œ")
    
    return ê²°ê³¼ëª©ë¡


# ========== ì¸í„°íŒŒí¬ íŒŒì„œ ==========
def parse_interpark(íŒŒì¼ê²½ë¡œ):
    """
    ì¸í„°íŒŒí¬ ì˜ˆë§¤ë‚´ì—­ ì—‘ì…€ íŒŒì¼ íŒŒì‹±
    
    íŒŒì¼ êµ¬ì¡°:
    - ì‹œíŠ¸: ë‚ ì§œë³„
    - í–‰3: ê³µì—°ëª…, ê³µì—°ì¼ì‹œ, íšŒì°¨
    - í–‰7~: ì˜ˆë§¤ì ë°ì´í„°
    
    Returns:
        list: ì˜ˆë§¤ ë°ì´í„° ë¦¬ìŠ¤íŠ¸
    """
    print("ğŸ“¥ ì¸í„°íŒŒí¬ íŒŒì¼ ë¶„ì„ ì¤‘...")
    xlsx = pd.ExcelFile(íŒŒì¼ê²½ë¡œ)
    ê²°ê³¼ëª©ë¡ = []
    
    for sheet_name in xlsx.sheet_names:
        df = pd.read_excel(xlsx, sheet_name=sheet_name, header=None)
        
        # í—¤ë” ì •ë³´ ì¶”ì¶œ
        ê³µì—°ëª…_ì›ë³¸ = df.iloc[2, 0]
        ê³µì—°ëª… = ê³µì—°ëª…ì •ê·œí™”(ê³µì—°ëª…_ì›ë³¸)
        
        ê³µì—°ì¼ì‹œ_ì›ë³¸ = str(df.iloc[2, 1])
        íšŒì°¨_ì›ë³¸ = str(df.iloc[2, 2])
        
        # ë‚ ì§œ íŒŒì‹±
        ë‚ ì§œë¶€ë¶„ = ê³µì—°ì¼ì‹œ_ì›ë³¸[:8]
        ì‹œê°„ë¶€ë¶„ = ê³µì—°ì¼ì‹œ_ì›ë³¸[9:]
        ê³µì—°ì¼ = f"{ë‚ ì§œë¶€ë¶„[:4]}-{ë‚ ì§œë¶€ë¶„[4:6]}-{ë‚ ì§œë¶€ë¶„[6:8]}"
        ê³µì—°ì‹œê°„ = f"{ì‹œê°„ë¶€ë¶„[:2]}:{ì‹œê°„ë¶€ë¶„[2:]}"
        
        íšŒì°¨ë²ˆí˜¸ = íšŒì°¨_ì›ë³¸.split()[0]
        íšŒì°¨ì •ë³´ = f"{íšŒì°¨ë²ˆí˜¸}íšŒì°¨ {ê³µì—°ì‹œê°„}"
        
        # ì˜ˆë§¤ì ë°ì´í„° ì¶”ì¶œ
        for i in range(6, len(df)):
            row = df.iloc[i]
            í‹°ì¼“ë²ˆí˜¸ = row[2]
            
            if pd.isna(í‹°ì¼“ë²ˆí˜¸) or not str(í‹°ì¼“ë²ˆí˜¸).startswith('T'):
                continue
            
            ì¢Œì„ì •ë³´ = str(row[4]).split(' ê°€ê²©ì •ë³´:')[0]
            ê°€ê²© = str(int(float(row[5])))
            
            ê²°ê³¼ëª©ë¡.append({
                'ê³µì—°ëª…': ê³µì—°ëª…,
                'ê³µì—°ì¼': ê³µì—°ì¼,
                'íšŒì°¨ì •ë³´': íšŒì°¨ì •ë³´,
                'ì˜ˆë§¤ì': str(row[9]),
                'í‹°ì¼“ë²ˆí˜¸': str(í‹°ì¼“ë²ˆí˜¸),
                'ì¢Œì„ì •ë³´': ì¢Œì„ì •ë³´,
                'ê°€ê²©': ê°€ê²©,
                'ì „í™”ë²ˆí˜¸': str(row[10]),
                'ì¶œì²˜': 'ì¸í„°íŒŒí¬'
            })
        
        print(f"  âœ… {sheet_name} - {len([x for x in ê²°ê³¼ëª©ë¡ if x['ì¶œì²˜']=='ì¸í„°íŒŒí¬'])}ëª… ì¶”ì¶œ")
    
    return ê²°ê³¼ëª©ë¡


# ========== í‹°ì¼“ë§í¬ íŒŒì„œ ==========
def parse_ticketlink(íŒŒì¼ê²½ë¡œ):
    """
    í‹°ì¼“ë§í¬ ì˜ˆë§¤ë‚´ì—­ ì—‘ì…€ íŒŒì¼ íŒŒì‹±
    
    íŒŒì¼ êµ¬ì¡°:
    - ì‹œíŠ¸: ì „ì²´ ë°ì´í„°ê°€ í•œ ì‹œíŠ¸
    - í–‰2: ê³µì—°ëª…
    - í–‰7~: ì˜ˆë§¤ì ë°ì´í„°
    
    Returns:
        list: ì˜ˆë§¤ ë°ì´í„° ë¦¬ìŠ¤íŠ¸
    """
    print("ğŸ“¥ í‹°ì¼“ë§í¬ íŒŒì¼ ë¶„ì„ ì¤‘...")
    df = pd.read_excel(íŒŒì¼ê²½ë¡œ, header=None)
    
    # ê³µì—°ëª… ì¶”ì¶œ
    ê³µì—°ëª…_ì›ë³¸ = str(df.iloc[1, 0]).replace('ìƒí’ˆëª… : ', '')
    ê³µì—°ëª… = ê³µì—°ëª…ì •ê·œí™”(ê³µì—°ëª…_ì›ë³¸)
    print(f"  ê³µì—°ëª…: {ê³µì—°ëª…[:30]}...")
    
    ê²°ê³¼ëª©ë¡ = []
    
    # ë°ì´í„° í–‰ ì¶”ì¶œ
    for i in range(6, len(df)):
        row = df.iloc[i]
        
        if pd.isna(row[0]):
            continue
        
        ê´€ëŒì¼_ì›ë³¸ = str(row[0])
        íšŒì°¨ì‹œê°„ = str(row[1])
        ì˜ˆë§¤ë²ˆí˜¸ = str(row[2]).split(' ')[0]
        ì„±ëª… = str(row[3]) if pd.notna(row[3]) else "ë¯¸ì œê³µ"
        ì—°ë½ì²˜ = str(row[4]) if pd.notna(row[4]) else "ë¯¸ì œê³µ"
        ê¶Œì¢… = str(row[9]) if pd.notna(row[9]) else ""
        ì¢Œì„ë²ˆí˜¸_ì›ë³¸ = row[10]
        
        # ë‚ ì§œ í˜•ì‹ ë³€í™˜
        ê³µì—°ì¼ = ê´€ëŒì¼_ì›ë³¸.replace('.', '-')
        
        # íšŒì°¨/ì‹œê°„ ë¶„ë¦¬
        íšŒì°¨ë²ˆí˜¸ = íšŒì°¨ì‹œê°„.split('/')[0]
        ê³µì—°ì‹œê°„ = íšŒì°¨ì‹œê°„.split('/')[1]
        íšŒì°¨ì •ë³´ = f"{íšŒì°¨ë²ˆí˜¸}íšŒì°¨ {ê³µì—°ì‹œê°„}"
        
        # ì¢Œì„ ë¶„ë¦¬ (ì—¬ëŸ¬ ì¢Œì„ ì²˜ë¦¬)
        ì¢Œì„ëª©ë¡ = str(ì¢Œì„ë²ˆí˜¸_ì›ë³¸).split(', ') if pd.notna(ì¢Œì„ë²ˆí˜¸_ì›ë³¸) else ["ë¹„ì§€ì •ì„"]
        
        for ì¢Œì„ in ì¢Œì„ëª©ë¡:
            # (1), (2) ë“± ë§¤ìˆ˜ í‘œì‹œ ì œê±°
            ì¢Œì„ì •ë¦¬ë¨ = re.sub(r'\(\d+\)', '', str(ì¢Œì„)).strip()
            
            ê²°ê³¼ëª©ë¡.append({
                'ê³µì—°ëª…': ê³µì—°ëª…,
                'ê³µì—°ì¼': ê³µì—°ì¼,
                'íšŒì°¨ì •ë³´': íšŒì°¨ì •ë³´,
                'ì˜ˆë§¤ì': ì„±ëª…,
                'í‹°ì¼“ë²ˆí˜¸': ì˜ˆë§¤ë²ˆí˜¸,
                'ì¢Œì„ì •ë³´': ì¢Œì„ì •ë¦¬ë¨,
                'ê°€ê²©': ê¶Œì¢…,
                'ì „í™”ë²ˆí˜¸': ì—°ë½ì²˜,
                'ì¶œì²˜': 'í‹°ì¼“ë§í¬'
            })
    
    print(f"  âœ… ì´ {len(ê²°ê³¼ëª©ë¡)}ëª… ì¶”ì¶œ")
    
    return ê²°ê³¼ëª©ë¡


# ========== ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ==========
def save_to_database(ë°ì´í„°ëª©ë¡, ì˜ˆë§¤ì²˜):
    """
    íŒŒì‹±ëœ ë°ì´í„°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
    
    Args:
        ë°ì´í„°ëª©ë¡: ì˜ˆë§¤ ë°ì´í„° ë¦¬ìŠ¤íŠ¸
        ì˜ˆë§¤ì²˜: ì˜ˆë§¤ì²˜ ì´ë¦„ (YES24, ì¸í„°íŒŒí¬, í‹°ì¼“ë§í¬)
    
    Returns:
        dict: ì €ì¥ ê²°ê³¼ (ì„±ê³µ/ì‹¤íŒ¨/ì¤‘ë³µ ê°œìˆ˜)
    """
    session = get_session()
    
    ì„±ê³µ = 0
    ì¤‘ë³µ = 0
    ì‹¤íŒ¨ = 0
    
    try:
        for ë°ì´í„° in ë°ì´í„°ëª©ë¡:
            try:
                # ë‚ ì§œ ë³€í™˜
                ê³µì—°ì¼_date = datetime.strptime(ë°ì´í„°['ê³µì—°ì¼'], '%Y-%m-%d').date()
                
                # Reservation ê°ì²´ ìƒì„±
                ì˜ˆë§¤ = Reservation(
                    ê³µì—°ëª…=ë°ì´í„°['ê³µì—°ëª…'],
                    ê³µì—°ì¼=ê³µì—°ì¼_date,
                    íšŒì°¨ì •ë³´=ë°ì´í„°['íšŒì°¨ì •ë³´'],
                    ì˜ˆë§¤ì=ë°ì´í„°['ì˜ˆë§¤ì'],
                    í‹°ì¼“ë²ˆí˜¸=ë°ì´í„°['í‹°ì¼“ë²ˆí˜¸'],
                    ì¢Œì„ì •ë³´=ë°ì´í„°['ì¢Œì„ì •ë³´'],
                    ê°€ê²©=ë°ì´í„°['ê°€ê²©'],
                    ì „í™”ë²ˆí˜¸=ë°ì´í„°['ì „í™”ë²ˆí˜¸'],
                    ì¶œì²˜=ë°ì´í„°['ì¶œì²˜']
                )
                
                session.add(ì˜ˆë§¤)
                session.commit()
                ì„±ê³µ += 1
                
            except IntegrityError:
                # í‹°ì¼“ë²ˆí˜¸ ì¤‘ë³µ (ì´ë¯¸ ì¡´ì¬)
                session.rollback()
                ì¤‘ë³µ += 1
                
            except Exception as e:
                session.rollback()
                ì‹¤íŒ¨ += 1
                print(f"    âš ï¸  ì €ì¥ ì‹¤íŒ¨: {ë°ì´í„°.get('í‹°ì¼“ë²ˆí˜¸', '?')} - {str(e)}")
        
        print(f"\nğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì™„ë£Œ!")
        print(f"   âœ… ì„±ê³µ: {ì„±ê³µ}ê°œ")
        if ì¤‘ë³µ > 0:
            print(f"   âš ï¸  ì¤‘ë³µ: {ì¤‘ë³µ}ê°œ (ì´ë¯¸ ì¡´ì¬)")
        if ì‹¤íŒ¨ > 0:
            print(f"   âŒ ì‹¤íŒ¨: {ì‹¤íŒ¨}ê°œ")
        
        return {
            'success': True,
            'ì„±ê³µ': ì„±ê³µ,
            'ì¤‘ë³µ': ì¤‘ë³µ,
            'ì‹¤íŒ¨': ì‹¤íŒ¨,
            'ì „ì²´': len(ë°ì´í„°ëª©ë¡)
        }
        
    except Exception as e:
        session.rollback()
        print(f"\nâŒ ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜: {e}")
        return {
            'success': False,
            'error': str(e)
        }
        
    finally:
        session.close()


# ========== í†µí•© ì²˜ë¦¬ í•¨ìˆ˜ ==========
def process_file(íŒŒì¼ê²½ë¡œ, ì˜ˆë§¤ì²˜):
    """
    ì˜ˆë§¤ì²˜ë³„ íŒŒì¼ ì²˜ë¦¬ í†µí•© í•¨ìˆ˜
    
    Args:
        íŒŒì¼ê²½ë¡œ: ì—‘ì…€ íŒŒì¼ ê²½ë¡œ
        ì˜ˆë§¤ì²˜: 'yes24', 'interpark', 'ticketlink'
    
    Returns:
        dict: ì²˜ë¦¬ ê²°ê³¼
    """
    print("\n" + "="*60)
    print(f"ğŸ« {ì˜ˆë§¤ì²˜.upper()} íŒŒì¼ ì²˜ë¦¬ ì‹œì‘")
    print("="*60)
    
    try:
        # ì˜ˆë§¤ì²˜ë³„ íŒŒì„œ í˜¸ì¶œ
        if ì˜ˆë§¤ì²˜.lower() == 'yes24':
            ë°ì´í„°ëª©ë¡ = parse_yes24(íŒŒì¼ê²½ë¡œ)
        elif ì˜ˆë§¤ì²˜.lower() == 'interpark':
            ë°ì´í„°ëª©ë¡ = parse_interpark(íŒŒì¼ê²½ë¡œ)
        elif ì˜ˆë§¤ì²˜.lower() == 'ticketlink':
            ë°ì´í„°ëª©ë¡ = parse_ticketlink(íŒŒì¼ê²½ë¡œ)
        else:
            return {
                'success': False,
                'error': f'ì•Œ ìˆ˜ ì—†ëŠ” ì˜ˆë§¤ì²˜: {ì˜ˆë§¤ì²˜}'
            }
        
        if not ë°ì´í„°ëª©ë¡:
            return {
                'success': False,
                'error': 'íŒŒì¼ì—ì„œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
            }
        
        # ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥
        ê²°ê³¼ = save_to_database(ë°ì´í„°ëª©ë¡, ì˜ˆë§¤ì²˜)
        
        print("="*60)
        print("âœ¨ ì²˜ë¦¬ ì™„ë£Œ!")
        print("="*60 + "\n")
        
        return ê²°ê³¼
        
    except Exception as e:
        print(f"\nâŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return {
            'success': False,
            'error': str(e)
        }
