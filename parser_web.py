"""
ì›¹ìš© í†µí•© íŒŒì„œ ëª¨ë“ˆ
ê¸°ì¡´ ì˜ˆë§¤ì²˜ë³„ íŒŒì„œë¥¼ ì›¹ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í†µí•©
ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ê¸°ëŠ¥ í¬í•¨
"""

import pandas as pd
from datetime import datetime
import re
from database import get_session, Reservation
from sqlalchemy.exc import IntegrityError


# ========== ê³µí†µ í•¨ìˆ˜ ==========
def ê³µì—°ëª…ì •ê·œí™”(ê³µì—°ëª…):
    """ê³µì—°ëª…ì˜ ê´„í˜¸ ì¢…ë¥˜ë¥¼ í†µì¼ (ã€ˆã€‰, [] â†’ ())"""
    ì •ê·œí™” = ê³µì—°ëª….replace('ã€ˆ', '(').replace('ã€‰', ')')
    ì •ê·œí™” = ì •ê·œí™”.replace('[', '(').replace(']', ')')
    ì •ê·œí™” = ì •ê·œí™”.replace('ã€', '(').replace('ã€‘', ')')
    return ì •ê·œí™”


# ========== YES24 íŒŒì„œ ==========
def parse_yes24(íŒŒì¼ê²½ë¡œ):
    """
    YES24 ì˜ˆë§¤ë‚´ì—­ ì—‘ì…€ íŒŒì¼ íŒŒì‹±
    ì¢Œì„ë³„ë¡œ ê°ê° í–‰ ìƒì„± (ë™ì¼ì¸ ì—¬ëŸ¬ ì¢Œì„ â†’ ì—°ì† í–‰ìœ¼ë¡œ í‘œì‹œ)
    """
    print("ğŸ“¥ YES24 íŒŒì¼ ë¶„ì„ ì¤‘...")
    xlsx = pd.ExcelFile(íŒŒì¼ê²½ë¡œ)
    ê²°ê³¼ëª©ë¡ = []
    
    for sheet_name in xlsx.sheet_names:
        df = pd.read_excel(xlsx, sheet_name=sheet_name, header=None)
        
        # í—¤ë” ì •ë³´ ì¶”ì¶œ
        ê³µì—°ëª…_ì›ë³¸ = df.iloc[4, 9]
        ê³µì—°ëª… = ê³µì—°ëª…ì •ê·œí™”(ê³µì—°ëª…_ì›ë³¸)
        
        ê³µì—°ì¼ì‹œ_ì›ë³¸ = str(df.iloc[5, 9])
        ê³µì—°ì¼ = ê³µì—°ì¼ì‹œ_ì›ë³¸[:10]
        ê³µì—°ì‹œê°„ = ê³µì—°ì¼ì‹œ_ì›ë³¸[11:16]
        
        # íšŒì°¨ ì •ë³´
        if '(' in sheet_name:
            íšŒì°¨ë²ˆí˜¸ = sheet_name.split('(')[1].replace(')', '')
        else:
            íšŒì°¨ë²ˆí˜¸ = "1"
        
        íšŒì°¨ì •ë³´ = f"{íšŒì°¨ë²ˆí˜¸}íšŒì°¨ {ê³µì—°ì‹œê°„}"
        
        # ì˜ˆë§¤ì ë°ì´í„° ì¶”ì¶œ (ì¢Œì„ë³„ë¡œ ê°ê° í–‰ ìƒì„±)
        for i in range(20, len(df)):
            row = df.iloc[i]
            í‹°ì¼“ë²ˆí˜¸ = row[12]
            
            if pd.isna(í‹°ì¼“ë²ˆí˜¸) or not str(í‹°ì¼“ë²ˆí˜¸).startswith('Y'):
                continue
            
            ì¢Œì„ì •ë³´ = str(row[16]) if pd.notna(row[16]) else "ë¹„ì§€ì •ì„"
            ê°€ê²© = str(int(row[18])) if pd.notna(row[18]) else "0"
            ì˜ˆë§¤ì = str(row[1])
            ì „í™”ë²ˆí˜¸ = str(row[4])
            í‹°ì¼“ë²ˆí˜¸_str = str(í‹°ì¼“ë²ˆí˜¸)
            
            # ê° ì¢Œì„ì„ ë³„ë„ í–‰ìœ¼ë¡œ ì¶”ê°€ (í‹°ì¼“ë²ˆí˜¸ì— ì¢Œì„ ì¶”ê°€í•˜ì—¬ ìœ ë‹ˆí¬í•˜ê²Œ)
            ê²°ê³¼ëª©ë¡.append({
                'ê³µì—°ëª…': ê³µì—°ëª…,
                'ê³µì—°ì¼': ê³µì—°ì¼,
                'íšŒì°¨ì •ë³´': íšŒì°¨ì •ë³´,
                'ì˜ˆë§¤ì': ì˜ˆë§¤ì,
                'í‹°ì¼“ë²ˆí˜¸': f"{í‹°ì¼“ë²ˆí˜¸_str}_{ì¢Œì„ì •ë³´}",
                'ì¢Œì„ì •ë³´': ì¢Œì„ì •ë³´,
                'ê°€ê²©': ê°€ê²©,
                'ì „í™”ë²ˆí˜¸': ì „í™”ë²ˆí˜¸,
                'ì¶œì²˜': 'YES24'
            })
    
    # ë™ì¼ì¸ ì—°ì† ì •ë ¬ (ì˜ˆë§¤ì+ì „í™”ë²ˆí˜¸ ê¸°ì¤€)
    ê²°ê³¼ëª©ë¡.sort(key=lambda x: (x['ì˜ˆë§¤ì'], x['ì „í™”ë²ˆí˜¸'], x['ì¢Œì„ì •ë³´']))
    
    print(f"  âœ… YES24 ì´ {len(ê²°ê³¼ëª©ë¡)}ê±´ ì¶”ì¶œ")
    return ê²°ê³¼ëª©ë¡


# ========== ì¸í„°íŒŒí¬ íŒŒì„œ ==========
def parse_interpark(íŒŒì¼ê²½ë¡œ):
    """
    ì¸í„°íŒŒí¬ ì˜ˆë§¤ë‚´ì—­ ì—‘ì…€ íŒŒì¼ íŒŒì‹±
    ì¢Œì„ì •ë³´ "4,5" â†’ ê°ê° ë³„ë„ í–‰ìœ¼ë¡œ ìƒì„±
    """
    print("ğŸ“¥ ì¸í„°íŒŒí¬ íŒŒì¼ ë¶„ì„ ì¤‘...")
    xlsx = pd.ExcelFile(íŒŒì¼ê²½ë¡œ)
    ê²°ê³¼ëª©ë¡ = []
    
    for sheet_name in xlsx.sheet_names:
        df = pd.read_excel(xlsx, sheet_name=sheet_name, header=None)
        
        # í—¤ë” ì •ë³´ ì¶”ì¶œ
        ê³µì—°ëª…_ì›ë³¸ = df.iloc[2, 0]
        ê³µì—°ëª… = ê³µì—°ëª…ì •ê·œí™”(ê³µì—°ëª…_ì›ë³¸)
        
        ê³µì—°ì¼ì‹œ_ì›ë³¸ = str(df.iloc[2, 1])
        íšŒì°¨_ì›ë³¸ = str(df.iloc[2, 2])
        
        # ë‚ ì§œ íŒŒì‹±
        ë‚ ì§œë¶€ë¶„ = ê³µì—°ì¼ì‹œ_ì›ë³¸[:8]
        ì‹œê°„ë¶€ë¶„ = ê³µì—°ì¼ì‹œ_ì›ë³¸[9:]
        ê³µì—°ì¼ = f"{ë‚ ì§œë¶€ë¶„[:4]}-{ë‚ ì§œë¶€ë¶„[4:6]}-{ë‚ ì§œë¶€ë¶„[6:8]}"
        ê³µì—°ì‹œê°„ = f"{ì‹œê°„ë¶€ë¶„[:2]}:{ì‹œê°„ë¶€ë¶„[2:]}"
        
        íšŒì°¨ë²ˆí˜¸ = íšŒì°¨_ì›ë³¸.split()[0]
        íšŒì°¨ì •ë³´ = f"{íšŒì°¨ë²ˆí˜¸}íšŒì°¨ {ê³µì—°ì‹œê°„}"
        
        # ì˜ˆë§¤ì ë°ì´í„° ì¶”ì¶œ
        ì²˜ë¦¬ëœ_ì¡°í•© = set()  # ì¤‘ë³µ ë°©ì§€
        
        for i in range(6, len(df)):
            row = df.iloc[i]
            í‹°ì¼“ë²ˆí˜¸ = row[2]
            
            if pd.isna(í‹°ì¼“ë²ˆí˜¸) or not str(í‹°ì¼“ë²ˆí˜¸).startswith('T'):
                continue
            
            í‹°ì¼“ë²ˆí˜¸_str = str(í‹°ì¼“ë²ˆí˜¸)
            
            # ì¢Œì„ì •ë³´ ì²˜ë¦¬ (ê°€ê²©ì •ë³´ ì œê±°)
            ì¢Œì„ì •ë³´_ì›ë³¸ = str(row[4]).split(' ê°€ê²©ì •ë³´:')[0]
            ê°€ê²© = str(int(float(row[5]))) if pd.notna(row[5]) else "0"
            ì˜ˆë§¤ì = str(row[9])
            ì „í™”ë²ˆí˜¸ = str(row[10])
            
            # ì¢Œì„ ë¶„ë¦¬: "ê°ì„1ì¸µ Cêµ¬ì—­ 2ì—´ 4,5" â†’ "ê°ì„1ì¸µ Cêµ¬ì—­ 2ì—´ 4", "ê°ì„1ì¸µ Cêµ¬ì—­ 2ì—´ 5"
            # ë§ˆì§€ë§‰ ë¶€ë¶„ì—ì„œ ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ì¢Œì„ë²ˆí˜¸ ë¶„ë¦¬
            ì¢Œì„_ë§¤ì¹˜ = re.match(r'(.+\s)(\d+(?:,\d+)+)$', ì¢Œì„ì •ë³´_ì›ë³¸)
            
            if ì¢Œì„_ë§¤ì¹˜:
                ì¢Œì„_ì•ë¶€ë¶„ = ì¢Œì„_ë§¤ì¹˜.group(1)  # "ê°ì„1ì¸µ Cêµ¬ì—­ 2ì—´ "
                ì¢Œì„_ë²ˆí˜¸ë“¤ = ì¢Œì„_ë§¤ì¹˜.group(2).split(',')  # ["4", "5"]
                
                for ì¢Œì„ë²ˆí˜¸ in ì¢Œì„_ë²ˆí˜¸ë“¤:
                    ì¢Œì„_ì „ì²´ = f"{ì¢Œì„_ì•ë¶€ë¶„}{ì¢Œì„ë²ˆí˜¸.strip()}"
                    ì¤‘ë³µí‚¤ = f"{í‹°ì¼“ë²ˆí˜¸_str}_{ì¢Œì„_ì „ì²´}"
                    
                    if ì¤‘ë³µí‚¤ in ì²˜ë¦¬ëœ_ì¡°í•©:
                        continue
                    ì²˜ë¦¬ëœ_ì¡°í•©.add(ì¤‘ë³µí‚¤)
                    
                    ê²°ê³¼ëª©ë¡.append({
                        'ê³µì—°ëª…': ê³µì—°ëª…,
                        'ê³µì—°ì¼': ê³µì—°ì¼,
                        'íšŒì°¨ì •ë³´': íšŒì°¨ì •ë³´,
                        'ì˜ˆë§¤ì': ì˜ˆë§¤ì,
                        'í‹°ì¼“ë²ˆí˜¸': ì¤‘ë³µí‚¤,
                        'ì¢Œì„ì •ë³´': ì¢Œì„_ì „ì²´,
                        'ê°€ê²©': ê°€ê²©,
                        'ì „í™”ë²ˆí˜¸': ì „í™”ë²ˆí˜¸,
                        'ì¶œì²˜': 'ì¸í„°íŒŒí¬'
                    })
            else:
                # ë³µìˆ˜ ì¢Œì„ì´ ì•„ë‹Œ ê²½ìš° ê·¸ëŒ€ë¡œ ì¶”ê°€
                ì¤‘ë³µí‚¤ = f"{í‹°ì¼“ë²ˆí˜¸_str}_{ì¢Œì„ì •ë³´_ì›ë³¸}"
                
                if ì¤‘ë³µí‚¤ in ì²˜ë¦¬ëœ_ì¡°í•©:
                    continue
                ì²˜ë¦¬ëœ_ì¡°í•©.add(ì¤‘ë³µí‚¤)
                
                ê²°ê³¼ëª©ë¡.append({
                    'ê³µì—°ëª…': ê³µì—°ëª…,
                    'ê³µì—°ì¼': ê³µì—°ì¼,
                    'íšŒì°¨ì •ë³´': íšŒì°¨ì •ë³´,
                    'ì˜ˆë§¤ì': ì˜ˆë§¤ì,
                    'í‹°ì¼“ë²ˆí˜¸': ì¤‘ë³µí‚¤,
                    'ì¢Œì„ì •ë³´': ì¢Œì„ì •ë³´_ì›ë³¸,
                    'ê°€ê²©': ê°€ê²©,
                    'ì „í™”ë²ˆí˜¸': ì „í™”ë²ˆí˜¸,
                    'ì¶œì²˜': 'ì¸í„°íŒŒí¬'
                })
    
    # ë™ì¼ì¸ ì—°ì† ì •ë ¬
    ê²°ê³¼ëª©ë¡.sort(key=lambda x: (x['ì˜ˆë§¤ì'], x['ì „í™”ë²ˆí˜¸'], x['ì¢Œì„ì •ë³´']))
    
    print(f"  âœ… ì¸í„°íŒŒí¬ ì´ {len(ê²°ê³¼ëª©ë¡)}ê±´ ì¶”ì¶œ")
    return ê²°ê³¼ëª©ë¡


# ========== í‹°ì¼“ë§í¬ íŒŒì„œ ==========
def parse_ticketlink(íŒŒì¼ê²½ë¡œ):
    """
    í‹°ì¼“ë§í¬ ì˜ˆë§¤ë‚´ì—­ ì—‘ì…€ íŒŒì¼ íŒŒì‹±
    ë³µìˆ˜ ì¢Œì„ â†’ ì¢Œì„ë³„ë¡œ ê°ê° í–‰ ìƒì„±
    """
    print("ğŸ“¥ í‹°ì¼“ë§í¬ íŒŒì¼ ë¶„ì„ ì¤‘...")
    df = pd.read_excel(íŒŒì¼ê²½ë¡œ, header=None)
    
    # ê³µì—°ëª… ì¶”ì¶œ
    ê³µì—°ëª…_ì›ë³¸ = str(df.iloc[1, 0]).replace('ìƒí’ˆëª… : ', '')
    ê³µì—°ëª… = ê³µì—°ëª…ì •ê·œí™”(ê³µì—°ëª…_ì›ë³¸)
    print(f"  ê³µì—°ëª…: {ê³µì—°ëª…[:30]}...")
    
    ê²°ê³¼ëª©ë¡ = []
    ì²˜ë¦¬ëœ_ì¡°í•© = set()  # ì¤‘ë³µ ë°©ì§€
    
    # ë°ì´í„° í–‰ ì¶”ì¶œ
    for i in range(6, len(df)):
        row = df.iloc[i]
        
        if pd.isna(row[0]):
            continue
        
        ê´€ëŒì¼_ì›ë³¸ = str(row[0])
        íšŒì°¨ì‹œê°„ = str(row[1])
        ì˜ˆë§¤ë²ˆí˜¸ = str(row[2]).split(' ')[0]
        ì„±ëª… = str(row[3]) if pd.notna(row[3]) else "ë¯¸ì œê³µ"
        ì—°ë½ì²˜ = str(row[4]) if pd.notna(row[4]) else "ë¯¸ì œê³µ"
        ê¶Œì¢… = str(row[9]) if pd.notna(row[9]) else ""
        ì¢Œì„ë²ˆí˜¸_ì›ë³¸ = row[10]
        
        # ë‚ ì§œ í˜•ì‹ ë³€í™˜
        ê³µì—°ì¼ = ê´€ëŒì¼_ì›ë³¸.replace('.', '-')
        
        # íšŒì°¨/ì‹œê°„ ë¶„ë¦¬
        íšŒì°¨ë²ˆí˜¸ = íšŒì°¨ì‹œê°„.split('/')[0] if '/' in íšŒì°¨ì‹œê°„ else "1"
        ê³µì—°ì‹œê°„ = íšŒì°¨ì‹œê°„.split('/')[1] if '/' in íšŒì°¨ì‹œê°„ else íšŒì°¨ì‹œê°„
        íšŒì°¨ì •ë³´ = f"{íšŒì°¨ë²ˆí˜¸}íšŒì°¨ {ê³µì—°ì‹œê°„}"
        
        # ì¢Œì„ ë¶„ë¦¬ (ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ë³µìˆ˜ ì¢Œì„)
        ì¢Œì„ì •ë³´_str = str(ì¢Œì„ë²ˆí˜¸_ì›ë³¸) if pd.notna(ì¢Œì„ë²ˆí˜¸_ì›ë³¸) else "ë¹„ì§€ì •ì„"
        ì¢Œì„ì •ë³´_str = re.sub(r'\(\d+\)', '', ì¢Œì„ì •ë³´_str).strip()  # ë§¤ìˆ˜ í‘œì‹œ ì œê±°
        
        # ì‰¼í‘œë¡œ ë¶„ë¦¬
        ì¢Œì„ëª©ë¡ = [s.strip() for s in ì¢Œì„ì •ë³´_str.split(',') if s.strip()]
        
        if not ì¢Œì„ëª©ë¡:
            ì¢Œì„ëª©ë¡ = ["ë¹„ì§€ì •ì„"]
        
        for ì¢Œì„ in ì¢Œì„ëª©ë¡:
            ì¤‘ë³µí‚¤ = f"{ì˜ˆë§¤ë²ˆí˜¸}_{ì¢Œì„}"
            
            if ì¤‘ë³µí‚¤ in ì²˜ë¦¬ëœ_ì¡°í•©:
                continue
            ì²˜ë¦¬ëœ_ì¡°í•©.add(ì¤‘ë³µí‚¤)
            
            ê²°ê³¼ëª©ë¡.append({
                'ê³µì—°ëª…': ê³µì—°ëª…,
                'ê³µì—°ì¼': ê³µì—°ì¼,
                'íšŒì°¨ì •ë³´': íšŒì°¨ì •ë³´,
                'ì˜ˆë§¤ì': ì„±ëª…,
                'í‹°ì¼“ë²ˆí˜¸': ì¤‘ë³µí‚¤,
                'ì¢Œì„ì •ë³´': ì¢Œì„,
                'ê°€ê²©': ê¶Œì¢…,
                'ì „í™”ë²ˆí˜¸': ì—°ë½ì²˜,
                'ì¶œì²˜': 'í‹°ì¼“ë§í¬'
            })
    
    # ë™ì¼ì¸ ì—°ì† ì •ë ¬
    ê²°ê³¼ëª©ë¡.sort(key=lambda x: (x['ì˜ˆë§¤ì'], x['ì „í™”ë²ˆí˜¸'], x['ì¢Œì„ì •ë³´']))
    
    print(f"  âœ… í‹°ì¼“ë§í¬ ì´ {len(ê²°ê³¼ëª©ë¡)}ê±´ ì¶”ì¶œ")
    return ê²°ê³¼ëª©ë¡


# ========== ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ==========
def save_to_database(ë°ì´í„°ëª©ë¡, ì˜ˆë§¤ì²˜):
    """
    íŒŒì‹±ëœ ë°ì´í„°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
    """
    session = get_session()
    
    ì„±ê³µ = 0
    ì¤‘ë³µ = 0
    ì‹¤íŒ¨ = 0
    
    try:
        for ë°ì´í„° in ë°ì´í„°ëª©ë¡:
            try:
                # ë‚ ì§œ ë³€í™˜
                ê³µì—°ì¼_date = datetime.strptime(ë°ì´í„°['ê³µì—°ì¼'], '%Y-%m-%d').date()
                
                # Reservation ê°ì²´ ìƒì„±
                ì˜ˆë§¤ = Reservation(
                    ê³µì—°ëª…=ë°ì´í„°['ê³µì—°ëª…'],
                    ê³µì—°ì¼=ê³µì—°ì¼_date,
                    íšŒì°¨ì •ë³´=ë°ì´í„°['íšŒì°¨ì •ë³´'],
                    ì˜ˆë§¤ì=ë°ì´í„°['ì˜ˆë§¤ì'],
                    í‹°ì¼“ë²ˆí˜¸=ë°ì´í„°['í‹°ì¼“ë²ˆí˜¸'],
                    ì¢Œì„ì •ë³´=ë°ì´í„°['ì¢Œì„ì •ë³´'],
                    ê°€ê²©=ë°ì´í„°['ê°€ê²©'],
                    ì „í™”ë²ˆí˜¸=ë°ì´í„°['ì „í™”ë²ˆí˜¸'],
                    ì¶œì²˜=ë°ì´í„°['ì¶œì²˜']
                )
                
                session.add(ì˜ˆë§¤)
                session.commit()
                ì„±ê³µ += 1
                
            except IntegrityError:
                session.rollback()
                ì¤‘ë³µ += 1
                
            except Exception as e:
                session.rollback()
                ì‹¤íŒ¨ += 1
                print(f"    âš ï¸  ì €ì¥ ì‹¤íŒ¨: {ë°ì´í„°.get('í‹°ì¼“ë²ˆí˜¸', '?')} - {str(e)}")
        
        print(f"\nğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì™„ë£Œ!")
        print(f"   âœ… ì„±ê³µ: {ì„±ê³µ}ê°œ")
        if ì¤‘ë³µ > 0:
            print(f"   âš ï¸  ì¤‘ë³µ: {ì¤‘ë³µ}ê°œ (ì´ë¯¸ ì¡´ì¬)")
        if ì‹¤íŒ¨ > 0:
            print(f"   âŒ ì‹¤íŒ¨: {ì‹¤íŒ¨}ê°œ")
        
        return {
            'success': True,
            'ì„±ê³µ': ì„±ê³µ,
            'ì¤‘ë³µ': ì¤‘ë³µ,
            'ì‹¤íŒ¨': ì‹¤íŒ¨,
            'ì „ì²´': len(ë°ì´í„°ëª©ë¡)
        }
        
    except Exception as e:
        session.rollback()
        print(f"\nâŒ ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜: {e}")
        return {
            'success': False,
            'error': str(e)
        }
        
    finally:
        session.close()


# ========== í†µí•© ì²˜ë¦¬ í•¨ìˆ˜ ==========
def process_file(íŒŒì¼ê²½ë¡œ, ì˜ˆë§¤ì²˜):
    """
    ì˜ˆë§¤ì²˜ë³„ íŒŒì¼ ì²˜ë¦¬ í†µí•© í•¨ìˆ˜
    """
    print("\n" + "="*60)
    print(f"ğŸ« {ì˜ˆë§¤ì²˜.upper()} íŒŒì¼ ì²˜ë¦¬ ì‹œì‘")
    print("="*60)
    
    try:
        # ì˜ˆë§¤ì²˜ë³„ íŒŒì„œ í˜¸ì¶œ
        if ì˜ˆë§¤ì²˜.lower() == 'yes24':
            ë°ì´í„°ëª©ë¡ = parse_yes24(íŒŒì¼ê²½ë¡œ)
        elif ì˜ˆë§¤ì²˜.lower() == 'interpark':
            ë°ì´í„°ëª©ë¡ = parse_interpark(íŒŒì¼ê²½ë¡œ)
        elif ì˜ˆë§¤ì²˜.lower() == 'ticketlink':
            ë°ì´í„°ëª©ë¡ = parse_ticketlink(íŒŒì¼ê²½ë¡œ)
        else:
            return {
                'success': False,
                'error': f'ì•Œ ìˆ˜ ì—†ëŠ” ì˜ˆë§¤ì²˜: {ì˜ˆë§¤ì²˜}'
            }
        
        if not ë°ì´í„°ëª©ë¡:
            return {
                'success': False,
                'error': 'íŒŒì¼ì—ì„œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
            }
        
        # ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥
        ê²°ê³¼ = save_to_database(ë°ì´í„°ëª©ë¡, ì˜ˆë§¤ì²˜)
        
        print("="*60)
        print("âœ¨ ì²˜ë¦¬ ì™„ë£Œ!")
        print("="*60 + "\n")
        
        return ê²°ê³¼
        
    except Exception as e:
        print(f"\nâŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return {
            'success': False,
            'error': str(e)
        }
